<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI å±…å®¶ç…§è­·ç³»çµ±ï¼šHealthLLM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- å­—é«”èˆ‡æ¨£å¼ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/navbar.css') }}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #f0f4f8;
            color: #333;
            padding: 2rem;
        }

        header {
            background: #a3d5d3;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2rem;
            color: #064f40;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        h2 {
            color: #2c7a7b;
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        input[type="text"], textarea, select, input[type="date"] {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        #date-navigation input[type="date"] {
             width: auto; /* Override for date picker in navigation */
        }

        button, .download-btn, .login-btn {
            padding: 0.7rem 1.5rem;
            background-color: #2c7a7b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        button:hover, .download-btn:hover, .login-btn:hover {
            background-color: #205e60;
        }

        .login-section {
            text-align: center;
            padding: 2rem;
        }

        .login-section p {
            margin-bottom: 1.5rem;
        }

        .login-btn {
            display: inline-flex;
            align-items: center;
            background-color: #4285F4;
        }

        .login-btn:hover {
            background-color: #3367D6;
        }

        .login-btn img {
            margin-right: 0.5rem;
            height: 1.5rem;
        }

        #summary-html, #summary-pdf, #trend-output, #trend-download, #question-output {
            margin-top: 1rem;
            line-height: 1.6;
        }

        #summary-status, #trend-status, #question-status, #linked-account-status, #bp-linked-status, #sugar-linked-status {
            margin-top: 0.5rem;
            font-size: 0.95rem;
            color: #444;
        }

        .status-success {
            color: #2c7a7b;
        }

        .status-error {
            color: #c62828;
        }

        .welcome-banner {
            background-color: #def7f6;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 0.5rem;
            text-align: center;
        }

        th {
            background-color: #a3d5d3;
        }

        input[type="number"] {
            width: 100%;
            border: none;
            padding: 0.3rem;
            text-align: center;
            background-color: transparent; /* Make input background transparent */
        }

        td input[type="number"]:focus {
            outline: 1px solid #2c7a7b; /* Highlight on focus */
        }

        #date-navigation {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center; /* Center the date controls */
            gap: 10px; /* Space between buttons and picker */
        }

        #date-navigation button {
            padding: 0.5rem 1rem; /* Smaller padding for date buttons */
        }

        .number-pad {
            display: none;
            position: absolute;
            background: #2c7a7b;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .number-button {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            font-size: 20px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            background-color: #f0f4f8;
            color: #333;
        }
        .number-pad button:hover {
            background-color: #e0e4e8;
        }

        /* Mobile-specific table styling */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            th, td {
                min-width: 100px; /* Adjust as needed */
                font-size: 0.9rem;
                padding: 0.3rem;
            }

            input[type="number"] {
                font-size: 0.9rem;
                padding: 0.2rem;
            }
            #date-navigation {
                flex-wrap: wrap; /* Allow wrapping for smaller screens */
            }
            #date-navigation input[type="date"] {
                margin-bottom: 0.5rem; /* Add some space if it wraps */
            }
            #date-navigation button {
                padding: 0.2rem 0.5rem; /* Smaller padding for date buttons */
            }
            .number-pad {
                display: none !important;
            }
        }

        /* Stack table rows for very small screens */
        @media (max-width: 480px) {
            table {
                display: table; /* Revert to table display */
                width: 100%;
            }

            thead {
                display: none; /* Hide table header */
            }

            tr {
                display: block; /* Each row as a block */
                margin-bottom: 0; /* Remove margin between rows */
                border: 1px solid #ccc; /* Add border around each "row" block */
                border-radius: 8px; /* Rounded corners for the block */
                padding: 0.5rem;
                margin-bottom: 1rem; /* Space between record blocks */
            }

            tr:last-child {
                margin-bottom: 0;
            }

            td {
                display: block; /* Each cell as a block */
                text-align: right; /* Align value to the right */
                position: relative;
                padding-left: 50%; /* Make space for the label */
                min-width: auto;
                border: none; /* Remove individual cell borders */
                border-bottom: 1px dashed #eee; /* Separator line between fields */
                padding-top: 0.8rem;
                padding-bottom: 0.8rem;
            }

            td:last-child {
                border-bottom: none; /* No line for the last field in a record */
            }

            td:before {
                content: attr(data-label); /* Use data-label for the pseudo-element */
                position: absolute;
                left: 0.5rem; /* Position label to the left */
                width: 45%; /* Width of the label */
                font-weight: bold;
                text-align: left; /* Align label text to the left */
            }

            input[type="number"] {
                width: 100%; /* Input takes full width of its container (the right part of td) */
                text-align: right; /* Align input text to the right */
            }
        }
    </style>
</head>
<body data-user-id="{{ current_user.id }}">
    {% include 'partials/navbar.html' %}

    <input type="hidden" id="auth-status" value="{{ current_user.is_authenticated }}">

    {% if current_user.is_authenticated %}
    <div class="welcome-banner">
        <h3>æ­¡è¿å›ä¾†ï¼Œ{{ current_user.name }}ï¼</h3>
        <p>æ‚¨å¯ä»¥åœ¨æ­¤é é¢æŸ¥çœ‹ã€ä¿®æ”¹åŠåˆ†æå·²é€£çµå¸³æˆ¶çš„å¥åº·è³‡æ–™ã€‚</p>
    </div>

    <div class="section">
        <h2>ğŸ”— é¸æ“‡é€£çµå¸³æˆ¶</h2>
        <label for="linked-account-select">é¸æ“‡å¸³æˆ¶ï¼š</label>
        <select id="linked-account-select" name="linked_account">
            <option value="">è«‹é¸æ“‡ä¸€å€‹å¸³æˆ¶</option>
            <option value="{{ current_user.id }}">è‡ªå·±çš„å¸³è™Ÿ</option>
            <!-- Options will be populated by JavaScript -->
        </select>
        <div id="linked-account-status"></div>
    </div>

    <div class="section" id="linked-account-data-section" style="display:none;">
        <h2>ğŸ“ é€£çµå¸³æˆ¶å¥åº·ç´€éŒ„</h2>

        <!-- Date Navigation -->
        <div id="date-navigation">
            <button id="prev-day-btn">< å‰ä¸€å¤©</button>
            <input type="date" id="current-date-picker">
            <button id="next-day-btn">å¾Œä¸€å¤© ></button>
        </div>

        <!-- Blood Pressure Data Display/Edit -->
        <h3>è¡€å£“ç´€éŒ„</h3>
        <form id="bp-linked-form">
            <table id="bp-linked-table">
                <thead>
                    <tr>
                        <th>æ—©ä¸Šæ”¶ç¸®å£“ (mmHg)</th>
                        <th>æ—©ä¸Šèˆ’å¼µå£“ (mmHg)</th>
                        <th>æ—©ä¸Šè„ˆæ (æ¬¡/åˆ†)</th>
                        <th>ä¸­åˆæ”¶ç¸®å£“ (mmHg)</th>
                        <th>ä¸­åˆèˆ’å¼µå£“ (mmHg)</th>
                        <th>ä¸­åˆè„ˆæ (æ¬¡/åˆ†)</th>
                        <th>æ™šä¸Šæ”¶ç¸®å£“ (mmHg)</th>
                        <th>æ™šä¸Šèˆ’å¼µå£“ (mmHg)</th>
                        <th>æ™šä¸Šè„ˆæ (æ¬¡/åˆ†)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td data-label="æ—©ä¸Šæ”¶ç¸®å£“ (mmHg)"><input type="number" name="morning_systolic" class="linked-data-input" placeholder="---"></td>
                        <td data-label="æ—©ä¸Šèˆ’å¼µå£“ (mmHg)"><input type="number" name="morning_diastolic" class="linked-data-input" placeholder="---"></td>
                        <td data-label="æ—©ä¸Šè„ˆæ (æ¬¡/åˆ†)"><input type="number" name="morning_pulse" class="linked-data-input" placeholder="---"></td>
                        <td data-label="ä¸­åˆæ”¶ç¸®å£“ (mmHg)"><input type="number" name="noon_systolic" class="linked-data-input" placeholder="---"></td>
                        <td data-label="ä¸­åˆèˆ’å¼µå£“ (mmHg)"><input type="number" name="noon_diastolic" class="linked-data-input" placeholder="---"></td>
                        <td data-label="ä¸­åˆè„ˆæ (æ¬¡/åˆ†)"><input type="number" name="noon_pulse" class="linked-data-input" placeholder="---"></td>
                        <td data-label="æ™šä¸Šæ”¶ç¸®å£“ (mmHg)"><input type="number" name="evening_systolic" class="linked-data-input" placeholder="---"></td>
                        <td data-label="æ™šä¸Šèˆ’å¼µå£“ (mmHg)"><input type="number" name="evening_diastolic" class="linked-data-input" placeholder="---"></td>
                        <td data-label="æ™šä¸Šè„ˆæ (æ¬¡/åˆ†)"><input type="number" name="evening_pulse" class="linked-data-input" placeholder="---"></td>
                    </tr>
                </tbody>
            </table>
            <button type="submit">ğŸ’¾ å„²å­˜è¡€å£“è®Šæ›´</button>
        </form>
        <div id="bp-linked-status"></div>

        <!-- Blood Sugar Data Display/Edit -->
        <h3>è¡€ç³–ç´€éŒ„</h3>
        <form id="sugar-linked-form">
            <table id="sugar-linked-table">
                <thead>
                    <tr>
                        <th>æ—©ä¸Šç©ºè…¹è¡€ç³– (mg/dL)</th>
                        <th>æ—©ä¸Šé¤å¾Œè¡€ç³– (mg/dL)</th>
                        <th>ä¸­åˆç©ºè…¹è¡€ç³– (mg/dL)</th>
                        <th>ä¸­åˆé¤å¾Œè¡€ç³– (mg/dL)</th>
                        <th>æ™šä¸Šç©ºè…¹è¡€ç³– (mg/dL)</th>
                        <th>æ™šä¸Šé¤å¾Œè¡€ç³– (mg/dL)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td data-label="æ—©ä¸Šç©ºè…¹è¡€ç³– (mg/dL)"><input type="number" name="morning_fasting" class="linked-data-input" placeholder="---"></td>
                        <td data-label="æ—©ä¸Šé¤å¾Œè¡€ç³– (mg/dL)"><input type="number" name="morning_postprandial" class="linked-data-input" placeholder="---"></td>
                        <td data-label="ä¸­åˆç©ºè…¹è¡€ç³– (mg/dL)"><input type="number" name="noon_fasting" class="linked-data-input" placeholder="---"></td>
                        <td data-label="ä¸­åˆé¤å¾Œè¡€ç³– (mg/dL)"><input type="number" name="noon_postprandial" class="linked-data-input" placeholder="---"></td>
                        <td data-label="æ™šä¸Šç©ºè…¹è¡€ç³– (mg/dL)"><input type="number" name="evening_fasting" class="linked-data-input" placeholder="---"></td>
                        <td data-label="æ™šä¸Šé¤å¾Œè¡€ç³– (mg/dL)"><input type="number" name="evening_postprandial" class="linked-data-input" placeholder="---"></td>
                    </tr>
                </tbody>
            </table>
            <button type="submit">ğŸ’¾ å„²å­˜è¡€ç³–è®Šæ›´</button>
        </form>
        <div id="sugar-linked-status"></div>
    </div>
    </div>

    <div id="linked-account-actions">
        <div class="section">
            <h2> å¥åº·è¶¨å‹¢åˆ†æ</h2>
            <p>é¸æ“‡é€£çµå¸³æˆ¶å¾Œï¼Œå¯ä¸Šå‚³è©²å¸³æˆ¶çš„ç…§è­·ç´€éŒ„é€²è¡Œåˆ†æã€‚</p>
            <form id="trend-form" enctype="multipart/form-data">
                <label for="trend-file">ğŸ“‚ ä¸Šå‚³ç…§è­·ç´€éŒ„ï¼ˆCSVï¼‰ï¼š</label>
                <input type="file" id="trend-file" name="file" accept=".csv" required>
                <label for="time-period">ğŸ•’ é¸æ“‡åˆ†ææ™‚é–“ç¯„åœï¼š</label>
                <select id="time-period" name="time_period">
                    <option value="today">ç•¶æ—¥</option>
                    <option value="7days">æœ€è¿‘ 7 å¤©</option>
                    <option value="30days">æœ€è¿‘ 30 å¤©</option>
                    <option value="all">æ‰€æœ‰æ­·å²æ•¸æ“š</option>
                </select>
                <button type="submit">ğŸ” åˆ†æå¥åº·è¶¨å‹¢èˆ‡è­¦ç¤º</button>
            </form>
            <div id="trend-status"></div>
            <div id="trend-output"></div>
            <div id="trend-download"></div>
        </div>
    </div>
    
    {% else %}
    <header>
        <h1>ğŸ§  AI å±…å®¶ç…§è­·ç³»çµ±ï¼šHealthLLM</h1>
        <p>ç”¨ç§‘æŠ€å®ˆè­·æ¯å€‹å®¶åº­çš„å¥åº· ğŸ’–</p>
    </header>
    <div class="section login-section">
        <h2>è«‹å…ˆç™»å…¥ç³»çµ±</h2>
        <p>ç‚ºäº†ä¿éšœæ‚¨çš„éš±ç§å’Œå¥åº·æ•¸æ“šå®‰å…¨ï¼Œä½¿ç”¨ç³»çµ±å‰è«‹å…ˆç™»å…¥</p>
        <a href="/auth/login" class="login-btn">
            <img src="/static/img/g-logo.png" alt="Google Logo" style="border-radius: 50%;" width="24px">
            ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
        </a>
    </div>
    <div class="section">
        <h2>ç³»çµ±åŠŸèƒ½ä»‹ç´¹</h2>
        <div style="padding: 1rem;">
            <div style="margin-bottom: 1.5rem;">
                <h3 style="color: #205e60; margin-bottom: 0.5rem;">ğŸ“ å¥åº·æ‘˜è¦èˆ‡å ±å‘Šç”¢ç”Ÿ</h3>
                <p>ä¸Šå‚³è¡€å£“æˆ–è¡€ç³–ç´€éŒ„æª”æ¡ˆï¼Œç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿå¥åº·æ‘˜è¦å ±å‘Šï¼Œæä¾›é”æ¨™ç‹€æ³èˆ‡é¤Šè­·å»ºè­°ã€‚</p>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="color: #205e60; margin-bottom: 0.5rem;">ğŸ“ˆ å¥åº·è¶¨å‹¢åˆ†æ</h3>
                <p>åˆ†æå¥åº·æ•¸æ“šé•·æœŸè¶¨å‹¢ï¼ŒåŠæ—©ç™¼ç¾æ½›åœ¨ç•°å¸¸è®ŠåŒ–ï¼Œæä¾›é é˜²æ€§å»ºè­°ã€‚</p>
            </div>
            <div>
                <h3 style="color: #205e60; margin-bottom: 0.5rem;">ğŸ’¬ ç…§è­·å•é¡Œå³æ™‚å•ç­”</h3>
                <p>é‡å°é•·ç…§ç…§è­·å•é¡Œæä¾›å°ˆæ¥­å›ç­”èˆ‡å»ºè­°ï¼Œå”åŠ©ç…§é¡§è€…è§£æ±ºç…§è­·ç–‘é›£ã€‚</p>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        {% if current_user.is_authenticated %}
        const socket = io();
        const linkedAccountSelect = document.getElementById('linked-account-select');
        const linkedAccountDataSection = document.getElementById('linked-account-data-section');
        const linkedAccountActions = document.getElementById('linked-account-actions');
        const datePicker = document.getElementById('current-date-picker');
        let currentSelectedDate;
        let currentUserId = document.body.dataset.userId;

        // Initialize Date Picker and Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            currentSelectedDate = new Date().toISOString().split('T')[0];
            datePicker.value = currentSelectedDate;

            datePicker.addEventListener('change', function() {
                currentSelectedDate = this.value;
                const selectedAccountId = linkedAccountSelect.value;
                if (selectedAccountId) {
                    fetchDataForLinkedAccount(selectedAccountId, currentSelectedDate);
                }
            });

            document.getElementById('prev-day-btn').addEventListener('click', function() {
                const currentDateObj = new Date(datePicker.value); // Use picker's current value
                currentDateObj.setDate(currentDateObj.getDate() - 1);
                currentSelectedDate = currentDateObj.toISOString().split('T')[0];
                datePicker.value = currentSelectedDate;
                // Trigger change event to fetch data
                datePicker.dispatchEvent(new Event('change'));
            });

            document.getElementById('next-day-btn').addEventListener('click', function() {
                const currentDateObj = new Date(datePicker.value); // Use picker's current value
                currentDateObj.setDate(currentDateObj.getDate() + 1);
                currentSelectedDate = currentDateObj.toISOString().split('T')[0];
                datePicker.value = currentSelectedDate;
                // Trigger change event to fetch data
                datePicker.dispatchEvent(new Event('change'));
            });

            // Fetch linked accounts on page load and set current user as default
            fetch('/get_linked_accounts')
                .then(response => response.json())
                .then(data => {
                    if (data.accounts && data.accounts.length > 0) {
                        data.accounts.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account.id;
                            option.textContent = account.name;
                            linkedAccountSelect.appendChild(option);
                        });
                        // Set current user as default
                        linkedAccountSelect.value = currentUserId;
                        linkedAccountDataSection.style.display = 'block';
                        fetchDataForLinkedAccount(currentUserId, currentSelectedDate);

                    } else {
                        document.getElementById('linked-account-status').textContent = 'æ²’æœ‰æ‰¾åˆ°é€£çµçš„å¸³æˆ¶ã€‚';
                    }
                })
                .catch(error => {
                    console.error('Error fetching linked accounts:', error);
                    document.getElementById('linked-account-status').textContent = 'è®€å–é€£çµå¸³æˆ¶å¤±æ•—ã€‚';
                });

            // Initialize date for the current user's input forms
            const today = new Date().toISOString().split('T')[0];
            const bpDateElem = document.getElementById('bp-date');
            const sugarDateElem = document.getElementById('sugar-date');
            if (bpDateElem) bpDateElem.value = today;
            if (sugarDateElem) sugarDateElem.value = today;
        });

        linkedAccountSelect.addEventListener('change', function() {
            const selectedAccountId = this.value;
            if (selectedAccountId) {
                linkedAccountDataSection.style.display = 'block';
                linkedAccountActions.style.display = 'block';
                fetchDataForLinkedAccount(selectedAccountId, currentSelectedDate);
            } else {
                linkedAccountDataSection.style.display = 'none';
                linkedAccountActions.style.display = 'none';
            }
        });

        function fetchDataForLinkedAccount(accountId, dateString) {
            document.getElementById('bp-linked-status').textContent = 'è®€å–ä¸­...';
            document.getElementById('sugar-linked-status').textContent = 'è®€å–ä¸­...';

            // Fetch BP data for the specific date
            fetch(`/get_linked_bp_data?user_id=${accountId}&date=${dateString}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('BP Data Received:', data); // Log raw BP data
                    if (data && typeof data.record !== 'undefined') {
                        populateBpForm(data.record);
                        document.getElementById('bp-linked-status').textContent = data.record ? 'è¡€å£“è³‡æ–™å·²è¼‰å…¥ã€‚' : 'æ­¤æ—¥æœŸç„¡è¡€å£“ç´€éŒ„ã€‚';
                    } else {
                        console.error('Unexpected BP data structure:', data);
                        clearBpForm();
                        document.getElementById('bp-linked-status').textContent = 'è¡€å£“è³‡æ–™æ ¼å¼éŒ¯èª¤æˆ–ç„¡ç´€éŒ„ã€‚';
                    }
                })
                .catch(error => {
                    console.error('Error fetching BP data:', error);
                    clearBpForm();
                    document.getElementById('bp-linked-status').textContent = `è®€å–è¡€å£“è³‡æ–™å¤±æ•—: ${error.message}`;
                });

            // Fetch Sugar data for the specific date
            fetch(`/get_linked_sugar_data?user_id=${accountId}&date=${dateString}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Sugar Data Received:', data); // Log raw Sugar data
                    if (data && typeof data.record !== 'undefined') {
                        populateSugarForm(data.record);
                        document.getElementById('sugar-linked-status').textContent = data.record ? 'è¡€ç³–è³‡æ–™å·²è¼‰å…¥ã€‚' : 'æ­¤æ—¥æœŸç„¡è¡€ç³–ç´€éŒ„ã€‚';
                    } else {
                        console.error('Unexpected Sugar data structure:', data);
                        clearSugarForm();
                        document.getElementById('sugar-linked-status').textContent = 'è¡€ç³–è³‡æ–™æ ¼å¼éŒ¯èª¤æˆ–ç„¡ç´€éŒ„ã€‚';
                    }
                })
                .catch(error => {
                    console.error('Error fetching Sugar data:', error);
                    clearSugarForm();
                    document.getElementById('sugar-linked-status').textContent = `è®€å–è¡€ç³–è³‡æ–™å¤±æ•—: ${error.message}`;
                });
        }

        function populateBpForm(record) {
            const form = document.getElementById('bp-linked-form');
            const fields = ['morning_systolic', 'morning_diastolic', 'morning_pulse',
                            'noon_systolic', 'noon_diastolic', 'noon_pulse',
                            'evening_systolic', 'evening_diastolic', 'evening_pulse'];
            const isCurrentUser = linkedAccountSelect.value === currentUserId;
            fields.forEach(fieldName => {
                const inputElement = form.querySelector(`input[name="${fieldName}"]`);
                if (inputElement) {
                    let value = record ? record[fieldName] : '';
                    inputElement.value = (value === 'ç„¡' || value === null || typeof value === 'undefined') ? '' : value;
                    if (isCurrentUser) {
                        inputElement.removeAttribute('readonly');
                        inputElement.style.backgroundColor = ''; // Remove transparent background
                    } else {
                        inputElement.setAttribute('readonly', true);
                        inputElement.style.backgroundColor = 'transparent'; // Keep transparent background for linked accounts
                    }
                }
            });
        }

        function clearBpForm() {
            const form = document.getElementById('bp-linked-form');
            const fields = ['morning_systolic', 'morning_diastolic', 'morning_pulse',
                            'noon_systolic', 'noon_diastolic', 'noon_pulse',
                            'evening_systolic', 'evening_diastolic', 'evening_pulse'];
            fields.forEach(fieldName => {
                const inputElement = form.querySelector(`input[name="${fieldName}"]`);
                if (inputElement) {
                    inputElement.value = '';
                }
            });
        }

        function populateSugarForm(record) {
            const form = document.getElementById('sugar-linked-form');
            const fields = ['morning_fasting', 'morning_postprandial',
                            'noon_fasting', 'noon_postprandial',
                            'evening_fasting', 'evening_postprandial'];
             const isCurrentUser = linkedAccountSelect.value === currentUserId;
            fields.forEach(fieldName => {
                const inputElement = form.querySelector(`input[name="${fieldName}"]`);
                if (inputElement) {
                     let value = record ? record[fieldName] : '';
                    inputElement.value = (value === 'ç„¡' || value === null || typeof value === 'undefined') ? '' : value;
                    //  if (isCurrentUser) {
                    //     inputElement.removeAttribute('readonly');
                    //     inputElement.style.backgroundColor = ''; // Remove transparent background
                    // } else {
                    //     inputElement.setAttribute('readonly', true);
                    //     inputElement.style.backgroundColor = 'transparent'; // Keep transparent background for linked accounts
                    // }
                }
            });
        }

        function clearSugarForm() {
            const form = document.getElementById('sugar-linked-form');
            const fields = ['morning_fasting', 'morning_postprandial',
                            'noon_fasting', 'noon_postprandial',
                            'evening_fasting', 'evening_postprandial'];
            fields.forEach(fieldName => {
                const inputElement = form.querySelector(`input[name="${fieldName}"]`);
                if (inputElement) {
                    inputElement.value = '';
                }
            });
        }

        // BP Linked Form Submission
        document.getElementById('bp-linked-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const selectedAccountId = linkedAccountSelect.value;
            if (!selectedAccountId) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹é€£çµå¸³æˆ¶ã€‚');
                return;
            }
            const record = { date: currentSelectedDate };
            record.morning_systolic = this.elements.morning_systolic.value || null;
            record.morning_diastolic = this.elements.morning_diastolic.value || null;
            record.morning_pulse = this.elements.morning_pulse.value || null;
            record.noon_systolic = this.elements.noon_systolic.value || null;
            record.noon_diastolic = this.elements.noon_diastolic.value || null;
            record.noon_pulse = this.elements.noon_pulse.value || null;
            record.evening_systolic = this.elements.evening_systolic.value || null;
            record.evening_diastolic = this.elements.evening_diastolic.value || null;
            record.evening_pulse = this.elements.evening_pulse.value || null;

            const recordsToSave = [record];
            document.getElementById('bp-linked-status').textContent = 'å„²å­˜ä¸­...';

            fetch('/update_linked_bp_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: selectedAccountId, records: recordsToSave })
            }).then(response => response.json())
              .then(data => {
                document.getElementById('bp-linked-status').textContent = data.message;
                if(data.success) {
                    fetchDataForLinkedAccount(selectedAccountId, currentSelectedDate);
                }
              })
              .catch(error => {
                console.error('Error updating BP data:', error);
                document.getElementById('bp-linked-status').textContent = 'è¡€å£“ç´€éŒ„æ›´æ–°å¤±æ•—ã€‚';
              });
        });

        // Sugar Linked Form Submission
        document.getElementById('sugar-linked-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const selectedAccountId = linkedAccountSelect.value;
            if (!selectedAccountId) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹é€£çµå¸³æˆ¶ã€‚');
                return;
            }
            const record = { date: currentSelectedDate };
            record.morning_fasting = this.elements.morning_fasting.value || null;
            record.morning_postprandial = this.elements.morning_postprandial.value || null;
            record.noon_fasting = this.elements.noon_fasting.value || null;
            record.noon_postprandial = this.elements.noon_postprandial.value || null;
            record.evening_fasting = this.elements.evening_fasting.value || null;
            record.evening_postprandial = this.elements.evening_postprandial.value || null;

            const recordsToSave = [record];
            document.getElementById('sugar-linked-status').textContent = 'å„²å­˜ä¸­...';

            fetch('/update_linked_sugar_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: selectedAccountId, records: recordsToSave })
            }).then(response => response.json())
              .then(data => {
                document.getElementById('sugar-linked-status').textContent = data.message;
                 if(data.success) {
                    fetchDataForLinkedAccount(selectedAccountId, currentSelectedDate);
                 }
              })
              .catch(error => {
                console.error('Error updating sugar data:', error);
                document.getElementById('sugar-linked-status').textContent = 'è¡€ç³–ç´€éŒ„æ›´æ–°å¤±æ•—ã€‚';
              });
        });

        // Handle update messages from server (e.g., save status)
        socket.on('update', function(data) {
            let statusDivId;
            // This mapping might need adjustment if 'data.target' is not specific enough
            if (data.target === 'linked_bp' || (data.message && data.message.includes('è¡€å£“'))) statusDivId = 'bp-linked-status';
            else if (data.target === 'linked_sugar' || (data.message && data.message.includes('è¡€ç³–'))) statusDivId = 'sugar-linked-status';
            else if (data.event_type === 'trend') statusDivId = 'trend-status';
            else if (data.event_type === 'question') statusDivId = 'question-status';
            else if (data.event_type === 'summary') statusDivId = 'summary-status'; // Added for the merged section
            else statusDivId = 'linked-account-status';

            const statusDiv = document.getElementById(statusDivId);
            if (statusDiv) {
                // Avoid overwriting "Loading..." or "Saving..." messages from direct fetch calls
                // if the socket message is a general one not tied to the current operation.
                // For now, we'll append. More sophisticated status handling might be needed.
                const statusClass = data.message.includes('âŒ') || data.message.includes('å¤±æ•—') ? 'status-error' : 'status-success';
                // If it's a success/error message from save, it might replace the "Saving..."
                if (statusDiv.textContent.includes('å„²å­˜ä¸­...') || statusDiv.textContent.includes('è®€å–ä¸­...')) {
                     statusDiv.innerHTML = `<p class="${statusClass}">${data.message}</p>`;
                } else {
                     statusDiv.innerHTML += `<p class="${statusClass}">${data.message}</p>`;
                }
                statusDiv.scrollTop = statusDiv.scrollHeight;
            }
        });

        // Trend form submission (adapted for linked accounts)
        document.getElementById('trend-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const selectedAccountId = linkedAccountSelect.value;
            if (!selectedAccountId) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹é€£çµå¸³æˆ¶ä»¥é€²è¡Œè¶¨å‹¢åˆ†æã€‚');
                return;
            }
            const formData = new FormData();
            formData.append('file', document.getElementById('trend-file').files[0]);
            formData.append('user_id', selectedAccountId);
            formData.append('time_period', document.getElementById('time-period').value); // Added time period

            document.getElementById('trend-status').innerHTML = '<p>ğŸ” åˆ†æä¸­ï¼Œè«‹ç¨å€™...</p>';
            document.getElementById('trend-output').innerHTML = '';
            document.getElementById('trend-download').innerHTML = '';

            fetch('/upload_trend_linked', {
                method: 'POST',
                body: formData
            }).then(response => response.text())
              .then(data => console.log('Trend upload for linked account started'))
              .catch(error => {
                  document.getElementById('trend-status').innerHTML = `<p class="status-error">âŒ ä¸Šå‚³å¤±æ•—: ${error}</p>`;
              });
        });

        socket.on('trend_result', function(data) {
            if (data.event_type === 'trend') {
                document.getElementById('trend-output').innerHTML = data.trend_output.replace(/\n/g, '<br>');
                if (data.trend_url) {
                    document.getElementById('trend-download').innerHTML = `<a href="${data.trend_url}" class="download-btn">ğŸ“Š ä¸‹è¼‰è¶¨å‹¢åœ–</a>`;
                }
                if (document.getElementById('trend-status').textContent.includes('åˆ†æä¸­')) {
                    document.getElementById('trend-status').innerHTML = `<p class="status-success">ğŸŸ¢ åˆ†æå®Œæˆ</p>`;
                }
            }
        });

        // Question form submission (adapted for linked accounts)
        document.getElementById('question-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const selectedAccountId = linkedAccountSelect.value;
            if (!selectedAccountId) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹é€£çµå¸³æˆ¶ä»¥æäº¤å•é¡Œã€‚');
                return;
            }
            const formData = new FormData();
            formData.append('question', document.getElementById('question').value);
            formData.append('user_id', selectedAccountId);

            document.getElementById('question-status').innerHTML = '<p>ğŸ’¡ æ€è€ƒä¸­ï¼Œè«‹ç¨å€™...</p>';
            document.getElementById('question-output').innerHTML = '';

            fetch('/ask_question_linked', {
                method: 'POST',
                body: formData
            }).then(response => response.text())
              .then(data => console.log('Question for linked account submitted'))
              .catch(error => {
                  if (error.message.toLowerCase() === 'failed to fetch') location.reload();
                  document.getElementById('question-status').innerHTML = `<p class="status-error">âŒ å•é¡Œæäº¤å¤±æ•—: ${error}</p>`;
              });
        });

        socket.on('question_result', function(data) {
            if (data.event_type === 'question') {
                document.getElementById('question-output').innerHTML = data.answer.replace(/\n/g, '<br>');
                if (document.getElementById('question-status').textContent.includes('æ€è€ƒä¸­')) {
                     document.getElementById('question-status').innerHTML = `<p class="status-success">ğŸŸ¢ å·²ç²å¾—å»ºè­°</p>`;
                }
            }
        });

        // Number pad logic (assuming it's still needed for input fields)
        let activeInput = null;
        const numberPad = document.getElementById('number-pad');
        const isMobile = window.innerWidth <= 768;

        function setupNumberPadListeners() {
            document.querySelectorAll('.linked-data-input').forEach(function(input) {
                input.addEventListener('click', function(e) {
                    if (isMobile || this.readOnly) {
                        this.focus();
                        return;
                    }
                    activeInput = this;
                    const rect = this.getBoundingClientRect();
                    if (numberPad) {
                        numberPad.style.display = 'grid';
                        numberPad.style.left = `${rect.left + window.scrollX}px`;
                        numberPad.style.top = `${rect.bottom + window.scrollY + 5}px`;
                    } else {
                        console.error("Number pad element not found!");
                    }
                });
            });

            if (numberPad && !isMobile) {
                const numberButtons = numberPad.querySelectorAll('.number-button');
                numberButtons.forEach(function(button) {
                    button.addEventListener('click', function() {
                        const buttonValue = this.textContent.trim();
                        if (activeInput && !activeInput.readOnly) {
                            if (!isNaN(parseInt(buttonValue, 10)) && buttonValue.length === 1) {
                                appendNumber(buttonValue);
                            } else if (buttonValue === 'C') {
                                clearNumber();
                            } else if (buttonValue === 'OK') {
                                closeNumberPad();
                            }
                        }
                    });
                });
            }
        }

        document.addEventListener('click', function(e) {
            if (!isMobile && activeInput && numberPad && !numberPad.contains(e.target) &&
                !e.target.classList.contains('linked-data-input')) {
                if (activeInput && !activeInput.readOnly) {
                    const min = parseFloat(activeInput.min);
                    const max = parseFloat(activeInput.max);
                    const value = parseFloat(activeInput.value);
                    if (activeInput.value && (isNaN(value) || value < min || value > max)) {
                        alert(`è«‹è¼¸å…¥ ${min} åˆ° ${max} ä¹‹é–“çš„æ•¸å€¼`);
                        activeInput.value = '';
                    }
                }
                if (numberPad) {
                    numberPad.style.display = 'none';
                }
                activeInput = null;
            }
        });

        function appendNumber(num) {
            if (activeInput) {
                activeInput.value += num;
            }
        }

        function clearNumber() {
            if (activeInput) {
                activeInput.value = '';
            }
        }

        function closeNumberPad() {
            if (activeInput) {
                const min = parseFloat(activeInput.min);
                const max = parseFloat(activeInput.max);
                const value = parseFloat(activeInput.value);
                if (activeInput.value && (isNaN(value) || value < min || value > max)) {
                    alert(`è«‹è¼¸å…¥ ${min} åˆ° ${max} ä¹‹é–“çš„æ•¸å€¼`);
                    activeInput.value = '';
                }
            }
            if (numberPad) {
                numberPad.style.display = 'none';
            }
            activeInput = null;
        }

        // Rest of the existing JavaScript code remains the same
        // ... (previous code for fetchDataForLinkedAccount, populateBpForm, etc.)

        // Call setup function after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupNumberPadListeners();
            // Other existing DOMContentLoaded logic
        });

        {% endif %}
    </script>
</body>
</html>
