<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·ç®¡ç† - é•·è€…ç•Œé¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link href="/static/css/navbar.css" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f0f4f8; color: #333; font-size: 1.5rem; line-height: 1.8; }
        header { background: #a3d5d3; padding-top: 1rem; padding-bottom: 0.5rem; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        header h1 { font-size: 2.5rem; color: #064f40; }
        .btn-custom { font-size: 1.75rem; padding: 1rem 2rem; border-radius: 12px; width: 100%; max-width: 500px; margin: 1rem auto; background-color: #2c7a7b; border: none; }
        .btn-custom:hover { background-color: #205e60; }
        .camera-scan-btn { background-color: #2c7a7b; border-color: #2c7a7b; color: white; }
        .camera-scan-btn:hover { background-color: #205e60; border-color: #205e60; color: white; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 1rem; margin-bottom: 1rem; }
        h3 { color: #2c7a7b; font-size: 2rem; }
        ul { list-style: none; padding-left: 0; }
        ul li { font-size: 1.2rem; }
        .container { padding: 1rem; }
        input[type="number"] { font-size: 1.25rem !important; font-weight: 700; color: #064f40; }
        .table>:not(caption)>*>* { color: #2c7a7b; }
        .fs-small { font-size: small; color: #2c7a7b; opacity: 0.7; }
        .status-card-green { background-color: #28a745 !important; border-color: #28a745 !important; }
        .status-card-red { background-color: #dc3545 !important; border-color: #dc3545 !important; }
        .warning-text { color: #dc3545; font-size: 1.5rem; margin-top: 0.5rem; }
        #health-status-card { display: none; }
    </style>
</head>
<body>
    {% include "partials/navbar.html" %}
    <header>
        <h1>ğŸ§  å¥åº·ç®¡ç†ç³»çµ±</h1>
        <p>ç°¡å–®æ˜“ç”¨ï¼Œå®ˆè­·æ‚¨çš„å¥åº· ğŸ’–</p>
    </header>
    <div class="container">
        <div class="card">
            <h3>ğŸ“ å¥åº·ç´€éŒ„è¼¸å…¥</h3>
            <div class="mb-3">
                <label for="record-date-elderly" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;">æ—¥æœŸï¼š</label>
                <input type="date" id="record-date-elderly" class="form-control form-control-lg" style="font-size: 1.25rem; max-width: 300px;">
            </div>
            <ul class="nav nav-tabs nav-fill" id="timeOfDayTab" role="tablist" style="margin-bottom: 1rem;">
                <li class="nav-item" role="presentation"><button class="nav-link" id="morning-tab-btn" data-bs-toggle="tab" data-bs-target="#morning-tab-pane" type="button" role="tab" aria-controls="morning-tab-pane" aria-selected="true">â˜€ï¸ æ—©ä¸Š</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="noon-tab-btn" data-bs-toggle="tab" data-bs-target="#noon-tab-pane" type="button" role="tab" aria-controls="noon-tab-pane" aria-selected="false">ğŸ•› ä¸­åˆ</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="evening-tab-btn" data-bs-toggle="tab" data-bs-target="#evening-tab-pane" type="button" role="tab" aria-controls="evening-tab-pane" aria-selected="false">ğŸŒ™ æ™šä¸Š</button></li>
            </ul>
            <form id="health-data-form-elderly">
                <div class="tab-content" id="timeOfDayTabContent">
                    <!-- Morning Tab Pane -->
                    <div class="tab-pane fade" id="morning-tab-pane" role="tabpanel" aria-labelledby="morning-tab-btn" tabindex="0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mt-3" style="font-size: 1.75rem;">è¡€å£“ç´€éŒ„</h4>
                            <button type="button" class="btn camera-scan-btn" data-bs-toggle="tooltip" title="ç›¸æ©Ÿæƒæè¡€å£“æ•¸å€¼" data-target-prefix="morning">ğŸ“· ç›¸æ©Ÿæƒæ</button>
                        </div>
                        <table class="table table-bordered" style="font-size: 1.25rem;">
                            <thead><tr><th>æ”¶ç¸®å£“ <span class="fs-small">(mmHg)</span></th><th>èˆ’å¼µå£“ <span class="fs-small">(mmHg)</span></th><th>è„ˆæ <span class="fs-small">(æ¬¡/åˆ†)</span></th></tr></thead>
                            <tbody><tr>
                                <td><input type="number" class="form-control form-control-lg health-input" name="morning_systolic" step="1" min="50" max="250"></td>
                                <td><input type="number" class="form-control form-control-lg health-input" name="morning_diastolic" step="1" min="30" max="150"></td>
                                <td><input type="number" class="form-control form-control-lg health-input" name="morning_pulse" step="1" min="30" max="200"></td>
                            </tr></tbody>
                        </table>
                        <h4 class="mt-3" style="font-size: 1.75rem;">è¡€ç³–ç´€éŒ„</h4>
                        <table class="table table-bordered" style="font-size: 1.25rem;">
                            <thead><tr><th>ç©ºè…¹è¡€ç³– <span class="fs-small">(mg/dL)</span></th><th>é¤å¾Œè¡€ç³– <span class="fs-small">(mg/dL)</span></th></tr></thead>
                            <tbody><tr>
                                <td><div class="input-group"><input type="number" class="form-control form-control-lg health-input" name="morning_fasting" step="1" min="50" max="300"><button type="button" class="btn camera-scan-btn" data-bs-toggle="tooltip" title="æƒæç©ºè…¹è¡€ç³–" data-target-field="morning_fasting" data-scan-type="fasting">ğŸ“·</button></div></td>
                                <td><div class="input-group"><input type="number" class="form-control form-control-lg health-input" name="morning_postprandial" step="1" min="70" max="400"><button type="button" class="btn camera-scan-btn" data-bs-toggle="tooltip" title="æƒæé¤å¾Œè¡€ç³–" data-target-field="morning_postprandial" data-scan-type="postprandial">ğŸ“·</button></div></td>
                            </tr></tbody>
                        </table>
                    </div>
                    <!-- Noon Tab Pane -->
                    <div class="tab-pane fade" id="noon-tab-pane" role="tabpanel" aria-labelledby="noon-tab-btn" tabindex="0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mt-3" style="font-size: 1.75rem;">è¡€å£“ç´€éŒ„</h4>
                            <button type="button" class="btn camera-scan-btn" data-bs-toggle="tooltip" title="ç›¸æ©Ÿæƒæè¡€å£“æ•¸å€¼" data-target-prefix="noon">ğŸ“· ç›¸æ©Ÿæƒæ</button>
                        </div>
                        <table class="table table-bordered" style="font-size: 1.25rem;">
                             <thead><tr><th>æ”¶ç¸®å£“ <span class="fs-small">(mmHg)</span></th><th>èˆ’å¼µå£“ <span class="fs-small">(mmHg)</span></th><th>è„ˆæ <span class="fs-small">(æ¬¡/åˆ†)</span></th></tr></thead>
                            <tbody><tr>
                                <td><input type="number" class="form-control form-control-lg health-input" name="noon_systolic" step="1" min="50" max="250"></td>
                                <td><input type="number" class="form-control form-control-lg health-input" name="noon_diastolic" step="1" min="30" max="150"></td>
                                <td><input type="number" class="form-control form-control-lg health-input" name="noon_pulse" step="1" min="30" max="200"></td>
                            </tr></tbody>
                        </table>
                        <h4 class="mt-3" style="font-size: 1.75rem;">è¡€ç³–ç´€éŒ„</h4>
                        <table class="table table-bordered" style="font-size: 1.25rem;">
                            <thead><tr><th>ç©ºè…¹è¡€ç³– <span class="fs-small">(mg/dL)</span></th><th>é¤å¾Œè¡€ç³– <span class="fs-small">(mg/dL)</span></th></tr></thead>
                            <tbody><tr>
                                <td><div class="input-group"><input type="number" class="form-control form-control-lg health-input" name="noon_fasting" step="1" min="50" max="300"><button type="button" class="btn camera-scan-btn" data-bs-toggle="tooltip" title="æƒæç©ºè…¹è¡€ç³–" data-target-field="noon_fasting" data-scan-type="fasting">ğŸ“·</button></div></td>
                                <td><div class="input-group"><input type="number" class="form-control form-control-lg health-input" name="noon_postprandial" step="1" min="70" max="400"><button type="button" class="btn camera-scan-btn" data-bs-toggle="tooltip" title="æƒæé¤å¾Œè¡€ç³–" data-target-field="noon_postprandial" data-scan-type="postprandial">ğŸ“·</button></div></td>
                            </tr></tbody>
                        </table>
                    </div>
                    <!-- Evening Tab Pane -->
                    <div class="tab-pane fade" id="evening-tab-pane" role="tabpanel" aria-labelledby="evening-tab-btn" tabindex="0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mt-3" style="font-size: 1.75rem;">è¡€å£“ç´€éŒ„</h4>
                            <button type="button" class="btn camera-scan-btn" data-bs-toggle="tooltip" title="ç›¸æ©Ÿæƒæè¡€å£“æ•¸å€¼" data-target-prefix="evening">ğŸ“· ç›¸æ©Ÿæƒæ</button>
                        </div>
                        <table class="table table-bordered" style="font-size: 1.25rem;">
                            <thead><tr><th>æ”¶ç¸®å£“ <span class="fs-small">(mmHg)</span></th><th>èˆ’å¼µå£“ <span class="fs-small">(mmHg)</span></th><th>è„ˆæ <span class="fs-small">(æ¬¡/åˆ†)</span></th></tr></thead>
                            <tbody><tr>
                                <td><input type="number" class="form-control form-control-lg health-input" name="evening_systolic" step="1" min="50" max="250"></td>
                                <td><input type="number" class="form-control form-control-lg health-input" name="evening_diastolic" step="1" min="30" max="150"></td>
                                <td><input type="number" class="form-control form-control-lg health-input" name="evening_pulse" step="1" min="30" max="200"></td>
                            </tr></tbody>
                        </table>
                        <h4 class="mt-3" style="font-size: 1.75rem;">è¡€ç³–ç´€éŒ„</h4>
                        <table class="table table-bordered" style="font-size: 1.25rem;">
                            <thead><tr><th>ç©ºè…¹è¡€ç³– <span class="fs-small">(mg/dL)</span></th><th>é¤å¾Œè¡€ç³– <span class="fs-small">(mg/dL)</span></th></tr></thead>
                            <tbody><tr>
                                <td><div class="input-group"><input type="number" class="form-control form-control-lg health-input" name="evening_fasting" step="1" min="50" max="300"><button type="button" class="btn camera-scan-btn" data-bs-toggle="tooltip" title="æƒæç©ºè…¹è¡€ç³–" data-target-field="evening_fasting" data-scan-type="fasting">ğŸ“·</button></div></td>
                                <td><div class="input-group"><input type="number" class="form-control form-control-lg health-input" name="evening_postprandial" step="1" min="70" max="400"><button type="button" class="btn camera-scan-btn" data-bs-toggle="tooltip" title="æƒæé¤å¾Œè¡€ç³–" data-target-field="evening_postprandial" data-scan-type="postprandial">ğŸ“·</button></div></td>
                            </tr></tbody>
                        </table>
                    </div>
                </div>
                <button type="submit" class="btn btn-custom text-white mt-3">ğŸ’¾ å„²å­˜æœ¬æ—¥æ•¸æ“š</button>
            </form>
            <div id="summary-status-elderly" class="mt-3" style="font-size: 1.25rem;"></div>
        </div>
        <div id="health-status-card" class="card mt-3">
            <h3>ä»Šæ—¥å¥åº·ç‹€æ…‹</h3>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div id="bp-status-card" class="card text-white text-center" style="display: none; font-size: 1.5rem;">
                        <div class="card-body">
                            <h5 class="card-title" style="font-size: 2rem;">è¡€å£“ç‹€æ…‹</h5>
                            <p id="bp-status-text" class="card-text" style="font-size: 1.7rem;"></p>
                            <p id="bp-normal-range" class="card-text" style="font-size: 1.5rem; opacity: 0.8;"></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div id="bs-status-card" class="card text-white text-center" style="display: none; font-size: 1.5rem;">
                        <div class="card-body">
                            <h5 class="card-title" style="font-size: 2rem;">è¡€ç³–ç‹€æ…‹</h5>
                            <p id="bs-status-text" class="card-text" style="font-size: 1.7rem;"></p>
                            <p id="bs-normal-range" class="card-text" style="font-size: 1.5rem; opacity: 0.8;"></p>
                        </div>
                    </div>
                </div>
            </div>
            <p id="health-warnings" class="warning-text"></p>
        </div>
        <div class="card">
            <h3>ä¸»è¦åŠŸèƒ½</h3>
            <button class="btn btn-custom text-white" onclick="location.href='/auth/profile'">æŸ¥çœ‹å€‹äººè³‡æ–™</button>
        </div>
    </div>
    <input type="file" id="camera-file-input" accept="image/*" capture="environment" style="display: none;">
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">ç¢ºèªæƒææ•¸å€¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>è«‹ç¢ºèªä»¥ä¸‹å¾åœ–ç‰‡ä¸­è­˜åˆ¥çš„æ•¸å€¼ï¼š</p>
                    <div id="scanned-values-container"></div>
                    <p class="mt-3">æ˜¯å¦å°‡é€™äº›æ•¸å€¼å¡«å…¥è¡¨æ ¼ï¼Ÿ</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary btn-lg" id="confirm-fill-btn">ç¢ºèªå¡«å…¥</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
        function setActiveTabByTime() {
            const now = new Date();
            const currentHour = now.getHours();
            let activeTabId = 'morning-tab-btn';
            if (currentHour >= 12 && currentHour <= 17) {
                activeTabId = 'noon-tab-btn';
            } else if (currentHour >= 18 || (currentHour >= 0 && currentHour <= 5)) {
                activeTabId = 'evening-tab-btn';
            }
            const tabElement = document.getElementById(activeTabId);
            if (tabElement) {
                const tab = new bootstrap.Tab(tabElement);
                tab.show();
            }
        }

        function loadHealthDataForDate(date) {
            if (!date) {
                date = new Date().toISOString().split('T')[0];
            }
            fetch(`/api/get_health_data_for_date?date=${date}`)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) return {};
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.querySelectorAll('.health-input').forEach(input => input.value = '');
                    if (data && Object.keys(data).length > 0) {
                        for (const key in data) {
                            const inputElement = document.querySelector(`.health-input[name="${key}"]`);
                            if (inputElement) {
                                inputElement.value = data[key];
                            }
                        }
                    }
                    if (typeof updateHealthUI === 'function') {
                        updateHealthUI();
                    }
                })
                .catch(error => {
                    console.error(`Error fetching health data for ${date}:`, error);
                    const statusDiv = document.getElementById('summary-status-elderly');
                    if (statusDiv) {
                        statusDiv.innerHTML = `<p class="text-danger">âš ï¸ è¼‰å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</p>`;
                    }
                });
        }

        function validateFormInputsElderly(inputs) {
            for (let input of inputs) {
                if (input.value) {
                    const min = parseFloat(input.min);
                    const max = parseFloat(input.max);
                    const value = parseFloat(input.value);
                    if (isNaN(value) || value < min || value > max) {
                        alert(`æ¬„ä½ ${input.name} è«‹è¼¸å…¥ ${min} åˆ° ${max} ä¹‹é–“çš„æœ‰æ•ˆæ•¸å€¼ã€‚`);
                        input.focus();
                        return false;
                    }
                }
            }
            return true;
        }

        async function checkBPStatus(systolic, diastolic) {
            if (!systolic || !diastolic) return { status: 'ç„¡è³‡æ–™', advice: 'è«‹è¼¸å…¥æ”¶ç¸®å£“å’Œèˆ’å¼µå£“ä»¥æª¢æŸ¥ç‹€æ…‹ã€‚' };
            const response = await fetch('/api/check_bp_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ systolic, diastolic })
            });
            return response.json();
        }

        async function checkBSStatus(value, type) {
            if (!value) return { status: 'ç„¡è³‡æ–™', advice: `è«‹è¼¸å…¥${type === 'fasting' ? 'ç©ºè…¹' : 'é¤å¾Œ'}è¡€ç³–ä»¥æª¢æŸ¥ç‹€æ…‹ã€‚` };
            const response = await fetch('/api/check_bs_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value, type })
            });
            return response.json();
        }

        async function updateHealthUI() {
            const activeTabPane = document.querySelector('.tab-pane.active');
            if (!activeTabPane) return;

            const timeOfDay = activeTabPane.id.split('-')[0];

            const bpSystolic = parseFloat(document.querySelector(`input[name="${timeOfDay}_systolic"]`).value) || 0;
            const bpDiastolic = parseFloat(document.querySelector(`input[name="${timeOfDay}_diastolic"]`).value) || 0;
            const bsFasting = parseFloat(document.querySelector(`input[name="${timeOfDay}_fasting"]`).value) || 0;
            const bsPostprandial = parseFloat(document.querySelector(`input[name="${timeOfDay}_postprandial"]`).value) || 0;

            const bpStatusCard = document.getElementById('bp-status-card');
            const bsStatusCard = document.getElementById('bs-status-card');
            const bpStatusText = document.getElementById('bp-status-text');
            const bsStatusText = document.getElementById('bs-status-text');
            const bpNormalRange = document.getElementById('bp-normal-range');
            const bsNormalRange = document.getElementById('bs-normal-range');
            const healthWarnings = document.getElementById('health-warnings');
            const healthStatusCard = document.getElementById('health-status-card');

            let hasAnyData = (bpSystolic > 0 || bpDiastolic > 0 || bsFasting > 0 || bsPostprandial > 0);
            healthStatusCard.style.display = hasAnyData ? 'block' : 'none';

            let bpStatus = '';
            let bsStatus = '';
            let warnings = [];

            if (bpSystolic > 0 && bpDiastolic > 0) {
                bpStatusCard.style.display = 'block';
                const bpResult = await checkBPStatus(bpSystolic, bpDiastolic);
                bpStatus = bpResult.status;
                
                if (bpStatus === 'æ­£å¸¸è¡€å£“') {
                    bpStatusCard.className = 'card text-white text-center status-card-green';
                } else {
                    bpStatusCard.className = 'card text-white text-center status-card-red';
                    if (bpStatus === 'é«˜è¡€å£“å±æ©Ÿ') warnings.push('âš ï¸ å¯èƒ½é«˜è¡€å£“å±è±¡');
                    else if (bpStatus === 'ç¬¬äºŒæœŸé«˜è¡€å£“') warnings.push('âš ï¸ å¯èƒ½é«˜è¡€å£“ç¬¬äºŒæœŸ');
                }
                bpStatusText.innerText = `è¡€å£“ç‹€æ…‹: ${bpStatus}`;
                bpNormalRange.innerText = bpResult.normal_range_info;
            } else {
                bpStatusCard.style.display = 'none';
            }

            if (bsFasting > 0 || bsPostprandial > 0) {
                bsStatusCard.style.display = 'block';
                let isNormal = true;
                if (bsFasting > 0) {
                    const fastingResult = await checkBSStatus(bsFasting, 'fasting');
                    if (fastingResult.status !== 'æ­£å¸¸ç©ºè…¹è¡€ç³–') isNormal = false;
                    if (fastingResult.status === 'ç³–å°¿ç—… (ç©ºè…¹)') warnings.push('âš ï¸ å¯èƒ½ç³–å°¿ç—… (ç©ºè…¹)');
                }
                if (bsPostprandial > 0) {
                    const postprandialResult = await checkBSStatus(bsPostprandial, 'postprandial');
                    if (postprandialResult.status !== 'æ­£å¸¸é¤å¾Œè¡€ç³–') isNormal = false;
                    if (postprandialResult.status === 'ç³–å°¿ç—… (é¤å¾Œ)') warnings.push('âš ï¸ å¯èƒ½ç³–å°¿ç—… (é¤å¾Œ)');
                }

                if (isNormal) {
                    bsStatus = 'é”æ¨™';
                    bsStatusCard.className = 'card text-white text-center status-card-green';
                } else {
                    bsStatus = 'æœªé”æ¨™';
                    bsStatusCard.className = 'card text-white text-center status-card-red';
                }
                bsStatusText.innerText = `è¡€ç³–ç‹€æ…‹: ${bsStatus}`;
                bsNormalRange.innerText = 'æ­£å¸¸ç¯„åœ: ç©ºè…¹è¡€ç³– < 100 mg/dL, é¤å¾Œè¡€ç³– < 140 mg/dL';
            } else {
                bsStatusCard.style.display = 'none';
            }

            healthWarnings.innerText = warnings.join(' ');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const recordDateInput = document.getElementById('record-date-elderly');
            recordDateInput.value = new Date().toISOString().split('T')[0];
            
            setActiveTabByTime();
            loadHealthDataForDate(recordDateInput.value);

            recordDateInput.addEventListener('change', (event) => {
                loadHealthDataForDate(event.target.value);
            });

            document.querySelectorAll('.health-input').forEach(input => {
                input.addEventListener('input', updateHealthUI);
            });

            document.querySelectorAll('#timeOfDayTab button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', updateHealthUI);
            });

            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            const healthDataFormElderly = document.getElementById('health-data-form-elderly');
            if (healthDataFormElderly) {
                healthDataFormElderly.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const allInputs = document.querySelectorAll('#timeOfDayTabContent .health-input');
                    if (!validateFormInputsElderly(allInputs)) return;

                    const formData = new FormData();
                    formData.append('date', recordDateInput.value);
                    
                    let hasDataToSave = false;
                    allInputs.forEach(input => {
                        // åªæ·»åŠ æœ‰å€¼çš„è¼¸å…¥æ¬„ä½åˆ° FormData
                        if (input.value.trim() !== '') {
                            formData.append(input.name, input.value.trim());
                            hasDataToSave = true;
                        }
                    });

                    if (!hasDataToSave) {
                        alert("è«‹è‡³å°‘è¼¸å…¥ä¸€ç­†å¥åº·æ•¸æ“šæ‰èƒ½å„²å­˜ã€‚");
                        return;
                    }
                    
                    const summaryStatusDivElderly = document.getElementById('summary-status-elderly');
                    summaryStatusDivElderly.innerHTML = `<p class="text-primary" style="font-size: 1.25rem;">æ­£åœ¨å„²å­˜æ•¸æ“š...</p>`;

                    fetch('/save_health_data', {
                        method: 'POST',
                        body: formData
                    }).then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.message || 'ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤'); });
                        }
                        return response.json();
                    }).then(data => {
                        // **FIX**: ç›´æ¥é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼Œè€Œä¸æ˜¯åªä¾è³´ socket
                        summaryStatusDivElderly.innerHTML = `<p class="text-success" style="font-size: 1.25rem;">âœ… ${data.message}</p>`;
                        // é‡æ–°è¼‰å…¥ç•¶æ—¥æ•¸æ“šï¼Œä»¥ç¢ºèªå„²å­˜æˆåŠŸ
                        loadHealthDataForDate(recordDateInput.value);
                    }).catch(error => {
                        if(summaryStatusDivElderly) summaryStatusDivElderly.innerHTML = `<p class="text-danger" style="font-size: 1.25rem;">âŒ å„²å­˜å¤±æ•—: ${error.message}</p>`;
                    });
                });
            }
        });

        // Socket.IO ç›£è½å™¨ä»ç„¶ä¿ç•™ï¼Œç”¨æ–¼æ¥æ”¶ä¾†è‡ªå¾Œç«¯çš„å…¶ä»–ç•°æ­¥æ›´æ–°
        const socket = io();
        socket.on('update', function(data) {
            const summaryStatusDivElderly = document.getElementById('summary-status-elderly');
            // åªåœ¨ä¸æ˜¯æ‰‹å‹•æäº¤æˆåŠŸè¨Šæ¯æ™‚æ›´æ–°ï¼Œé¿å…è¦†è“‹
            if (summaryStatusDivElderly && !summaryStatusDivElderly.querySelector('.text-success')) {
                const statusClass = data.message.includes('âŒ') ? 'text-danger' : 'text-info';
                summaryStatusDivElderly.innerHTML = `<p class="${statusClass}" style="font-size: 1.25rem;">${data.message}</p>`;
            }
        });
    </script>
</body>
</html>